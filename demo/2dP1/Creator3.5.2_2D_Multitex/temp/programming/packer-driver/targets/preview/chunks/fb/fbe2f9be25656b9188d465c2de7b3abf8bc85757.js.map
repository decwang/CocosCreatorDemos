{"version":3,"sources":["file:///Users/mu/work/gitee/CocosCreatorDemos/demo/2dP1/Creator3.5.1_2D_Multitex/assets/src/MTBatcher2D.ts"],"names":["MTBatcher2D","StencilManager","Color","textures","samplers","textureHashs","samplerHashs","curIsMTSprite","texBindingMap","Map","getTexturesIdx","textHash","i","length","addTexture","texture","maxTextureSize","push","canBatchTexture","getSamplerIdx","samplerHash","addSampler","sampler","canBatchSampler","reset","getInstance","gInstance","setTexturesBindingMap","bm","hackBatch2d","batcher","isHacked","mtBatcher","commitComp","origin_getDescriptorSet","_descriptorSetCache","getDescriptorSet","batch","ds","call","fromMTSprite","pass","passes","texName","has","binding","get","bindTexture","bindSampler","origin_autoMergeBatches","autoMergeBatches","renderComp","originLength","_batches","newLength","isMTSprite","_isMTSprite","comp","renderData","frame","assembler","transform","getGFXTexture","textureHash","getHash","samp","getGFXSampler","hash","dataHash","mat","bufferID","chunk","isValid","material","bufferId","stencilStage","sharedManager","stage","depthStencilStateStage","_currHash","_currMaterial","currDepthStencilStateStage","GL_MAX_Texture","_currComponent","isMeshBuffer","updateBuffer","vertexFormat","_currRenderData","_currTransform","getRenderMaterial","_currDepthStencilStateStage","_currLayer","node","layer","_currTexture","_currSampler","_currTextureHash","_currSamplerHash","sp","color","fillBuffers"],"mappings":";;;wCAGaA,W;;;;;;;AAF6CC,MAAAA,c,OAAAA,c;AAAqBC,MAAAA,K,OAAAA,K;;;;;;;6BAElEF,W,GAAN,MAAMA,WAAN,CAAkB;AAAA;AAAA,eAMbG,QANa,GAMa,EANb;AAAA,eAObC,QAPa,GAOa,EAPb;AAAA,eAQbC,YARa,GAQY,EARZ;AAAA,eASbC,YATa,GASY,EATZ;AAAA,eAUbC,aAVa,GAUY,KAVZ;AAAA,eAWbC,aAXa,GAWwB,IAAIC,GAAJ,EAXxB;AAAA;;AAabC,QAAAA,cAAc,CAACC,QAAD,EAA2B;AAC7C,eAAK,IAAIC,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKP,YAAL,CAAkBQ,MAAtC,EAA8CD,CAAC,EAA/C,EAAmD;AAC/C,gBAAI,KAAKP,YAAL,CAAkBO,CAAlB,MAAyBD,QAA7B,EAAuC;AACnC,qBAAOC,CAAP;AACH;AACJ;;AAED,iBAAO,CAAC,CAAR;AACH;;AAEOE,QAAAA,UAAU,CAACC,OAAD,EAAuBJ,QAAvB,EAAyCK,cAAzC,EAA0E;AACxF,cAAI,KAAKb,QAAL,CAAcU,MAAd,IAAwBG,cAA5B,EAA4C;AACxC,mBAAO,KAAP;AACH;;AACD,eAAKb,QAAL,CAAcc,IAAd,CAAmBF,OAAnB;AACA,eAAKV,YAAL,CAAkBY,IAAlB,CAAuBN,QAAvB;AAEA,iBAAO,IAAP;AACH;;AAEOO,QAAAA,eAAe,CAACH,OAAD,EAAuBJ,QAAvB,EAAyCK,cAAzC,EAA0E;AAC7F,cAAI,KAAKN,cAAL,CAAoBC,QAApB,KAAiC,CAArC,EAAwC;AACpC,mBAAO,IAAP;AACH;;AACD,cAAI,KAAKG,UAAL,CAAgBC,OAAhB,EAAyBJ,QAAzB,EAAmCK,cAAnC,CAAJ,EAAwD;AACpD,mBAAO,IAAP;AACH;;AACD,iBAAO,KAAP;AACH;;AAEOG,QAAAA,aAAa,CAACC,WAAD,EAA8B;AAC/C,eAAK,IAAIR,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAG,KAAKN,YAAL,CAAkBO,MAAtC,EAA8CD,CAAC,EAA/C,EAAmD;AAC/C,gBAAI,KAAKN,YAAL,CAAkBM,CAAlB,MAAyBQ,WAA7B,EAA0C;AACtC,qBAAOR,CAAP;AACH;AACJ;;AAED,iBAAO,CAAC,CAAR;AACH;;AAEOS,QAAAA,UAAU,CAACC,OAAD,EAAuBF,WAAvB,EAA4CJ,cAA5C,EAA6E;AAC3F,cAAI,KAAKZ,QAAL,CAAcS,MAAd,IAAwBG,cAA5B,EAA4C;AACxC,mBAAO,KAAP;AACH;;AACD,eAAKZ,QAAL,CAAca,IAAd,CAAmBK,OAAnB;AACA,eAAKhB,YAAL,CAAkBW,IAAlB,CAAuBG,WAAvB;AAEA,iBAAO,IAAP;AACH;;AAEOG,QAAAA,eAAe,CAACD,OAAD,EAAuBF,WAAvB,EAA4CJ,cAA5C,EAA6E;AAChG,cAAI,KAAKG,aAAL,CAAmBC,WAAnB,KAAmC,CAAvC,EAA0C;AACtC,mBAAO,IAAP;AACH;;AACD,cAAI,KAAKC,UAAL,CAAgBC,OAAhB,EAAyBF,WAAzB,EAAsCJ,cAAtC,CAAJ,EAA2D;AACvD,mBAAO,IAAP;AACH;;AACD,iBAAO,KAAP;AACH;;AAEOQ,QAAAA,KAAK,GAAG;AACZ,eAAKrB,QAAL,CAAcU,MAAd,GAAuB,CAAvB;AACA,eAAKR,YAAL,CAAkBQ,MAAlB,GAA2B,CAA3B;AACA,eAAKT,QAAL,CAAcS,MAAd,GAAuB,CAAvB;AACA,eAAKP,YAAL,CAAkBO,MAAlB,GAA2B,CAA3B;AACH;;AAEwB,eAAXY,WAAW,GAAgB;AACrC,iBAAOzB,WAAW,CAAC0B,SAAnB;AACH;;AAEMC,QAAAA,qBAAqB,CAACC,EAAD,EAA0B;AAClD,eAAKpB,aAAL,GAAqBoB,EAArB;AACH;;AAEMC,QAAAA,WAAW,CAACC,OAAD,EAAc;AAC5B,cAAI9B,WAAW,CAAC+B,QAAhB,EAA0B;AACtB;AACH;;AACD/B,UAAAA,WAAW,CAAC+B,QAAZ,GAAuB,IAAvB;AACA,cAAMC,SAAS,GAAGhC,WAAW,CAACyB,WAAZ,EAAlB;AACAK,UAAAA,OAAO,CAACG,UAAR,GAAqBjC,WAAW,CAACiC,UAAjC;AACAH,UAAAA,OAAO,CAACE,SAAR,GAAoBA,SAApB;AAEA,cAAME,uBAAuB,GAAGJ,OAAO,CAACK,mBAAR,CAA4BC,gBAA5D;;AACAN,UAAAA,OAAO,CAACK,mBAAR,CAA4BC,gBAA5B,GAA+C,UAASC,KAAT,EAAqB;AAChE,gBAAMC,EAAE,GAAGJ,uBAAuB,CAACK,IAAxB,CAA6B,IAA7B,EAAmCF,KAAnC,CAAX;;AACA,gBAAIA,KAAK,CAACG,YAAV,EAAwB;AACpB,kBAAMC,IAAI,GAAGJ,KAAK,CAACK,MAAN,CAAa,CAAb,CAAb;;AACA,mBAAK,IAAI9B,CAAC,GAAG,CAAb,EAAgBA,CAAC,GAAGoB,SAAS,CAAC7B,QAAV,CAAmBU,MAAvC,EAA+CD,CAAC,EAAhD,EAAoD;AAChD,oBAAM+B,OAAO,GAAG,kBAAkB/B,CAAlC;;AACA,oBAAIoB,SAAS,CAACxB,aAAV,CAAwBoC,GAAxB,CAA4BD,OAA5B,CAAJ,EAA0C;AACtC,sBAAME,OAAO,GAAGb,SAAS,CAACxB,aAAV,CAAwBsC,GAAxB,CAA4BH,OAA5B,CAAhB;;AACA,sBAAIX,SAAS,CAAC7B,QAAV,CAAmBS,CAAnB,CAAJ,EAA2B;AACvB6B,oBAAAA,IAAI,CAACM,WAAL,CAAiBF,OAAjB,EAA0Bb,SAAS,CAAC7B,QAAV,CAAmBS,CAAnB,CAA1B;AACH;;AACD,sBAAIoB,SAAS,CAAC5B,QAAV,CAAmBQ,CAAnB,CAAJ,EAA2B;AACvB6B,oBAAAA,IAAI,CAACO,WAAL,CAAiBH,OAAjB,EAA0Bb,SAAS,CAAC5B,QAAV,CAAmBQ,CAAnB,CAA1B;AACH;AACJ;AACJ;AACJ;;AAED,mBAAO0B,EAAP;AACH,WAnBD;;AAqBA,cAAMW,uBAAuB,GAAGnB,OAAO,CAACoB,gBAAxC;;AACApB,UAAAA,OAAO,CAACoB,gBAAR,GAA2B,UAASC,UAAT,EAAoC;AAC3D,gBAAMC,YAAY,GAAG,KAAKC,QAAL,CAAcxC,MAAnC;AACAoC,YAAAA,uBAAuB,CAACV,IAAxB,CAA6B,IAA7B,EAAmCY,UAAnC;AACA,gBAAMG,SAAS,GAAG,KAAKD,QAAL,CAAcxC,MAAhC;;AACA,gBAAIyC,SAAS,KAAKF,YAAlB,EAAgC;AAC5B;AACH;;AACD,gBAAMG,UAAmB,GAAGJ,UAAU,CAACK,WAAX,IAA0B,KAAtD;AACA,iBAAKH,QAAL,CAAcP,GAAd,CAAkBQ,SAAS,GAAC,CAA5B,EAA+Bd,YAA/B,GAA8Ce,UAA9C;AACH,WATD;AAUH;;AAEuB,eAAVtB,UAAU,CAACwB,IAAD,EAAqBC,UAArB,EAAwDC,KAAxD,EAAmFC,SAAnF,EAAmGC,SAAnG,EAA2H;AAC/I,cAAM7B,SAAS,GAAG,KAAKA,SAAvB;AACA,cAAMuB,UAAmB,GAAGE,IAAI,CAACD,WAAL,IAAoB,KAAhD;AAEA,cAAMzC,OAAO,GAAG4C,KAAK,GAAGA,KAAK,CAACG,aAAN,EAAH,GAA2B,IAAhD;AACA,cAAMC,WAAW,GAAGJ,KAAK,GAAGA,KAAK,CAACK,OAAN,EAAH,GAAqB,CAA9C;AACA,cAAMC,IAAI,GAAGN,KAAK,GAAGA,KAAK,CAACO,aAAN,EAAH,GAA2B,IAA7C;AACA,cAAM9C,WAAW,GAAGuC,KAAK,GAAGA,KAAK,CAACO,aAAN,GAAsBC,IAAzB,GAAgC,CAAzD;AAEA,cAAIC,QAAQ,GAAG,CAAf;AACA,cAAIC,GAAJ;AACA,cAAIC,QAAQ,GAAG,CAAC,CAAhB;;AACA,cAAIZ,UAAU,IAAIA,UAAU,CAACa,KAA7B,EAAoC;AAChC,gBAAI,CAACb,UAAU,CAACc,OAAX,EAAL,EAA2B;AAC3BJ,YAAAA,QAAQ,GAAGV,UAAU,CAACU,QAAtB;AACAC,YAAAA,GAAG,GAAGX,UAAU,CAACe,QAAjB;AACAH,YAAAA,QAAQ,GAAGZ,UAAU,CAACa,KAAX,CAAiBG,QAA5B;AACH;;AACDjB,UAAAA,IAAI,CAACkB,YAAL,GAAoB1E,cAAc,CAAC2E,aAAf,CAA8BC,KAAlD;AACA,cAAMC,sBAAsB,GAAGrB,IAAI,CAACkB,YAApC,CAnB+I,CAqB/I;;AACA,cAAI,KAAKI,SAAL,KAAmBX,QAAnB,IAA+BA,QAAQ,KAAK,CAA5C,IAAiD,KAAKY,aAAL,KAAuBX,GAAxE,IAA+E,KAAKY,0BAAL,KAAoCH,sBAAnH,IACG9C,SAAS,CAACzB,aAAV,KAA4BgD,UAD/B,IAEG,CAACvB,SAAS,CAACd,eAAV,CAA0BH,OAA1B,EAAmCgD,WAAnC,EAAgDR,UAAU,GAAGvD,WAAW,CAACkF,cAAf,GAAgC,CAA1F,CAFJ,IAGG,CAAClD,SAAS,CAACT,eAAV,CAA0B0C,IAA1B,EAAgC7C,WAAhC,EAA6CmC,UAAU,GAAGvD,WAAW,CAACkF,cAAf,GAAgC,CAAvF,CAHR,EAIM;AACF,iBAAKhC,gBAAL,CAAsB,KAAKiC,cAA3B;AACAnD,YAAAA,SAAS,CAACR,KAAV;AACAQ,YAAAA,SAAS,CAAClB,UAAV,CAAqBC,OAArB,EAA8BgD,WAA9B;AACA/B,YAAAA,SAAS,CAACX,UAAV,CAAqB4C,IAArB,EAA2B7C,WAA3B;AACAY,YAAAA,SAAS,CAACzB,aAAV,GAA0BgD,UAA1B;;AAEA,gBAAIG,UAAU,IAAI,CAACA,UAAU,CAAC0B,YAA9B,EAA4C;AACxC,mBAAKC,YAAL,CAAkB3B,UAAU,CAAC4B,YAA7B,EAA2ChB,QAA3C;AACH;;AAED,iBAAKiB,eAAL,GAAuB7B,UAAvB;AACA,iBAAKqB,SAAL,GAAiBrB,UAAU,GAAGA,UAAU,CAACU,QAAd,GAAyB,CAApD;AACA,iBAAKe,cAAL,GAAsB1B,IAAtB;AACA,iBAAK+B,cAAL,GAAsB3B,SAAtB;AACA,iBAAKmB,aAAL,GAAqBvB,IAAI,CAACgC,iBAAL,CAAuB,CAAvB,CAArB;AACA,iBAAKC,2BAAL,GAAmCZ,sBAAnC;AACA,iBAAKa,UAAL,GAAkBlC,IAAI,CAACmC,IAAL,CAAUC,KAA5B;;AAEA,gBAAIlC,KAAJ,EAAW;AACP,mBAAKmC,YAAL,GAAoBnC,KAAK,CAACG,aAAN,EAApB;AACA,mBAAKiC,YAAL,GAAoBpC,KAAK,CAACO,aAAN,EAApB;AACA,mBAAK8B,gBAAL,GAAwBrC,KAAK,CAACK,OAAN,EAAxB;AACA,mBAAKiC,gBAAL,GAAwB,KAAKF,YAAL,CAAkB5B,IAA1C;AACH,aALD,MAKO;AACH,mBAAK2B,YAAL,GAAoB,IAApB;AACA,mBAAKC,YAAL,GAAoB,IAApB;AACA,mBAAKC,gBAAL,GAAwB,CAAxB;AACA,mBAAKC,gBAAL,GAAwB,CAAxB;AACH;AACJ;;AAED,cAAI1C,UAAJ,EAAgB;AACZ,gBAAM2C,EAAE,GAAGzC,IAAX;AACAyC,YAAAA,EAAE,CAACC,KAAH,GAAW,IAAIjG,KAAJ,CAAU8B,SAAS,CAACtB,cAAV,CAAyB,KAAKsF,gBAA9B,CAAV,CAAX;AACH;;AACD,cAAIpC,SAAJ,EAAe;AACXA,YAAAA,SAAS,CAACwC,WAAV,CAAsB3C,IAAtB,EAA4B,IAA5B;AACH;AACJ;;AArMoB,O;;AAAZzD,MAAAA,W,CAEekF,c,GAAiB,C;AAFhClF,MAAAA,W,CAGM+B,Q,GAAW,K;AAHjB/B,MAAAA,W,CAIM0B,S,GAAyB,IAAI1B,WAAJ,E","sourcesContent":["\nimport { _decorator, Node, UI, Renderable2D, SpriteFrame, StencilManager, gfx, Color, Sprite, BaseRenderData } from 'cc';\n\nexport class MTBatcher2D {\n\n    private static readonly GL_MAX_Texture = 8;\n    private static isHacked = false;\n    private static gInstance: MTBatcher2D = new MTBatcher2D();\n\n    private textures: gfx.Texture[] = [];\n    private samplers: gfx.Sampler[] = [];\n    private textureHashs: number[] = [];\n    private samplerHashs: number[] = [];\n    private curIsMTSprite: boolean = false;\n    private texBindingMap: Map<string, number> = new Map<string, number>();\n\n    private getTexturesIdx(textHash: number): number {\n        for (let i = 0; i < this.textureHashs.length; i++) {\n            if (this.textureHashs[i] === textHash) {\n                return i;\n            }\n        }\n\n        return -1;\n    }\n\n    private addTexture(texture: gfx.Texture, textHash: number, maxTextureSize: number): boolean {\n        if (this.textures.length >= maxTextureSize) {\n            return false;\n        }\n        this.textures.push(texture);\n        this.textureHashs.push(textHash);\n\n        return true;\n    }\n\n    private canBatchTexture(texture: gfx.Texture, textHash: number, maxTextureSize: number): boolean {\n        if (this.getTexturesIdx(textHash) >= 0) {\n            return true;\n        }\n        if (this.addTexture(texture, textHash, maxTextureSize)) {\n            return true;\n        }\n        return false;\n    }\n\n    private getSamplerIdx(samplerHash: number): number {\n        for (let i = 0; i < this.samplerHashs.length; i++) {\n            if (this.samplerHashs[i] === samplerHash) {\n                return i;\n            }\n        }\n\n        return -1;\n    }\n\n    private addSampler(sampler: gfx.Sampler, samplerHash: number, maxTextureSize: number): boolean {\n        if (this.samplers.length >= maxTextureSize) {\n            return false;\n        }\n        this.samplers.push(sampler);\n        this.samplerHashs.push(samplerHash);\n\n        return true;\n    }\n\n    private canBatchSampler(sampler: gfx.Sampler, samplerHash: number, maxTextureSize: number): boolean {\n        if (this.getSamplerIdx(samplerHash) >= 0) {\n            return true;\n        }\n        if (this.addSampler(sampler, samplerHash, maxTextureSize)) {\n            return true;\n        }\n        return false;\n    }\n\n    private reset() {\n        this.textures.length = 0;\n        this.textureHashs.length = 0;\n        this.samplers.length = 0;\n        this.samplerHashs.length = 0;\n    }\n\n    public static getInstance(): MTBatcher2D {\n        return MTBatcher2D.gInstance;\n    }\n\n    public setTexturesBindingMap(bm: Map<string, number>) {\n        this.texBindingMap = bm;\n    }\n\n    public hackBatch2d(batcher: UI) {\n        if (MTBatcher2D.isHacked) {\n            return;\n        }\n        MTBatcher2D.isHacked = true;\n        const mtBatcher = MTBatcher2D.getInstance();\n        batcher.commitComp = MTBatcher2D.commitComp;\n        batcher.mtBatcher = mtBatcher;\n\n        const origin_getDescriptorSet = batcher._descriptorSetCache.getDescriptorSet;\n        batcher._descriptorSetCache.getDescriptorSet = function(batch: any) {\n            const ds = origin_getDescriptorSet.call(this, batch);\n            if (batch.fromMTSprite) {\n                const pass = batch.passes[0];\n                for (let i = 1; i < mtBatcher.textures.length; i++) {\n                    const texName = \"spriteTexture\" + i;\n                    if (mtBatcher.texBindingMap.has(texName)) {\n                        const binding = mtBatcher.texBindingMap.get(texName);\n                        if (mtBatcher.textures[i]) {\n                            pass.bindTexture(binding, mtBatcher.textures[i]);\n                        }\n                        if (mtBatcher.samplers[i]) {\n                            pass.bindSampler(binding, mtBatcher.samplers[i]);\n                        }\n                    }\n                }\n            }\n\n            return ds;\n        }\n\n        const origin_autoMergeBatches = batcher.autoMergeBatches;\n        batcher.autoMergeBatches = function(renderComp?: Renderable2D) {\n            const originLength = this._batches.length;\n            origin_autoMergeBatches.call(this, renderComp);\n            const newLength = this._batches.length;\n            if (newLength === originLength) {\n                return;\n            }\n            const isMTSprite: boolean = renderComp._isMTSprite || false;\n            this._batches.get(newLength-1).fromMTSprite = isMTSprite;\n        }\n    }\n\n    public static commitComp(comp: Renderable2D, renderData: BaseRenderData | null, frame: SpriteFrame | null, assembler: any, transform: Node | null) {\n        const mtBatcher = this.mtBatcher as any as MTBatcher2D\n        const isMTSprite: boolean = comp._isMTSprite || false;\n        \n        const texture = frame ? frame.getGFXTexture() : null;\n        const textureHash = frame ? frame.getHash() : 0;\n        const samp = frame ? frame.getGFXSampler() : null;\n        const samplerHash = frame ? frame.getGFXSampler().hash : 0; \n\n        let dataHash = 0;\n        let mat;\n        let bufferID = -1;\n        if (renderData && renderData.chunk) {\n            if (!renderData.isValid()) return;\n            dataHash = renderData.dataHash;\n            mat = renderData.material;\n            bufferID = renderData.chunk.bufferId;\n        }\n        comp.stencilStage = StencilManager.sharedManager!.stage;\n        const depthStencilStateStage = comp.stencilStage;\n\n        // @ts-ignore\n        if (this._currHash !== dataHash || dataHash === 0 || this._currMaterial !== mat || this.currDepthStencilStateStage !== depthStencilStateStage\n            || mtBatcher.curIsMTSprite !== isMTSprite\n            || !mtBatcher.canBatchTexture(texture, textureHash, isMTSprite ? MTBatcher2D.GL_MAX_Texture : 1)\n            || !mtBatcher.canBatchSampler(samp, samplerHash, isMTSprite ? MTBatcher2D.GL_MAX_Texture : 1)\n            ) {\n            this.autoMergeBatches(this._currComponent!);\n            mtBatcher.reset();\n            mtBatcher.addTexture(texture, textureHash);\n            mtBatcher.addSampler(samp, samplerHash);\n            mtBatcher.curIsMTSprite = isMTSprite;\n\n            if (renderData && !renderData.isMeshBuffer) {\n                this.updateBuffer(renderData.vertexFormat, bufferID);\n            }\n\n            this._currRenderData = renderData;\n            this._currHash = renderData ? renderData.dataHash : 0;\n            this._currComponent = comp;\n            this._currTransform = transform;\n            this._currMaterial = comp.getRenderMaterial(0)!;\n            this._currDepthStencilStateStage = depthStencilStateStage;\n            this._currLayer = comp.node.layer;\n\n            if (frame) {\n                this._currTexture = frame.getGFXTexture();\n                this._currSampler = frame.getGFXSampler();\n                this._currTextureHash = frame.getHash();\n                this._currSamplerHash = this._currSampler.hash;\n            } else {\n                this._currTexture = null;\n                this._currSampler = null;\n                this._currTextureHash = 0;\n                this._currSamplerHash = 0;\n            }\n        }\n\n        if (isMTSprite) {\n            const sp = comp as Sprite;\n            sp.color = new Color(mtBatcher.getTexturesIdx(this._currTextureHash));\n        }\n        if (assembler) {\n            assembler.fillBuffers(comp, this);\n        }\n    }\n\n}\n\n"]}