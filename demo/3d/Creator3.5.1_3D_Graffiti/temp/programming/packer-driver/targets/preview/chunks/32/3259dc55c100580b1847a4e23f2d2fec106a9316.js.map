{"version":3,"sources":["file:///Users/mu/work/gitee/CocosCreatorDemos/demo/3d/Creator3.5.1_3D_Graffiti/assets/scripts/decal.ts"],"names":["_decorator","Component","systemEvent","SystemEvent","geometry","Camera","MeshRenderer","gfx","Vec3","Node","Mat4","Mat3","Vec4","Material","DecalMeshRenderer","ccclass","property","Decal","meshRenderer","isTouchMove","_ray","Ray","modOpt","distance","Infinity","doubleSided","mode","ERaycastMode","ANY","subIndices","result","start","onEnable","on","EventType","TOUCH_START","onTouchStart","TOUCH_MOVE","onTouchMove","TOUCH_END","onTouchEnd","onDisable","off","touch","event","delta","getUIDelta","length","point","getLocation","mainCamera","screenPointToRay","x","y","position","normal","getTouchPointOnModel","console","log","addDecal","getComponent","mo","model","me","mesh","intersectCount","intersect","rayModel","set","ZERO","r","s","renderingSubMeshes","subIdx","pos","geometricInfo","positions","pa","posIndex","vertexIndex0","pb","vertexIndex1","pc","vertexIndex2","add","divide3f","normals","readAttribute","AttributeName","ATTR_NORMAL","nIdx","computeHit","transformMat4","node","worldMatrix","projectorEye","worldPosition","debugCube","setWorldPosition","removeFromParent","addChild","dmr","addComponent","scale","subtract","normalize","genDecalMesh","decalMaterial","newMat","copy","setProperty","Math","random","material","rotateForVectors","a","b","v","cross","c","dot","v1","v2","v3","z","h","vx","rm","matrix3Dot","multiplyScalar","IDENTITY","ma","mb","m","m00","m01","m03","m02","m06","m04","m07","m05","m08","matrix4Dot","m12","m09","m13","m10","m14","m11","m15"],"mappings":"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","sourcesContent":["\r\nimport { _decorator, Component, systemEvent, SystemEvent, EventTouch, Touch, geometry, Camera, MeshRenderer, gfx, Vec3, find, Node, Mat4, Mat3, Vec4, Quat, Material, random } from 'cc';\r\nimport { DecalMeshRenderer } from './DecalMeshRenderer';\r\nconst { ccclass, property } = _decorator;\r\n \r\n@ccclass('Decal')\r\nexport class Decal extends Component {\r\n\r\n    @property(Camera)\r\n    mainCamera: Camera | null = null;\r\n\r\n    @property(Material)\r\n    decalMaterial: Material | null = null;\r\n\r\n    @property(Node)\r\n    debugCube: Node | null = null;\r\n\r\n    private meshRenderer: MeshRenderer | null = null;\r\n    private isTouchMove: boolean = false;\r\n    private _ray = new geometry.Ray();\r\n    private modOpt: geometry.IRayModelOptions = {\r\n        distance: Infinity,\r\n        doubleSided: false,\r\n        mode: geometry.ERaycastMode.ANY,\r\n        subIndices: [],\r\n        result: []\r\n    };\r\n\r\n    start () {\r\n    }\r\n\r\n    onEnable () {\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_START, this.onTouchStart, this);\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        systemEvent.on(SystemEvent.EventType.TOUCH_END, this.onTouchEnd, this);\r\n    }\r\n\r\n    onDisable () {\r\n        systemEvent.off(SystemEvent.EventType.TOUCH_START, this.onTouchStart, this);\r\n        systemEvent.off(SystemEvent.EventType.TOUCH_MOVE, this.onTouchMove, this);\r\n        systemEvent.off(SystemEvent.EventType.TOUCH_END, this.onTouchEnd, this);\r\n    }\r\n\r\n    onTouchStart (touch: Touch, event: EventTouch) {\r\n        this.isTouchMove = false;\r\n    }\r\n\r\n    onTouchMove (touch: Touch, event: EventTouch) {\r\n        const delta = touch.getUIDelta();\r\n        if (delta.length() > 0.1) {\r\n            this.isTouchMove = true;\r\n        }\r\n    }\r\n\r\n    onTouchEnd (touch: Touch, event: EventTouch) {\r\n        if (this.isTouchMove) { return; }\r\n        this.isTouchMove = false;\r\n\r\n        const point = touch.getLocation();\r\n        this.mainCamera?.screenPointToRay(point.x, point.y, this._ray);\r\n        const position = new Vec3();\r\n        const normal = new Vec3();\r\n        if (!this.getTouchPointOnModel(position, normal)) {\r\n            console.log('Not touch on model');\r\n            return;\r\n        }\r\n        this.addDecal(position, normal);\r\n    }\r\n\r\n    getTouchPointOnModel(position: Vec3, normal: Vec3): boolean {\r\n        if (null == this.meshRenderer) {\r\n            this.meshRenderer = this.getComponent(MeshRenderer);\r\n        }\r\n        const mo = this.meshRenderer?.model;\r\n        if (!mo) {\r\n            console.log('model is null');\r\n            return false;\r\n        }\r\n        const me = this.meshRenderer?.mesh;\r\n        if (!me) {\r\n            console.log('mesh is null');\r\n            return false;\r\n        }\r\n\r\n        if (this.modOpt.result) { this.modOpt.result.length = 0; }\r\n        if (this.modOpt.subIndices) { this.modOpt.subIndices.length = 0; }\r\n        const intersectCount = geometry.intersect.rayModel(this._ray, mo, this.modOpt);\r\n        if (0 == intersectCount) {\r\n            return false;\r\n        }\r\n\r\n        if (!this.modOpt.subIndices || !this.modOpt.result) {\r\n            console.log(this.modOpt);\r\n            return false;\r\n        }\r\n        position.set(Vec3.ZERO);\r\n        const r = this.modOpt.result!;\r\n        const s = this.modOpt.subIndices;\r\n\r\n        if (me.renderingSubMeshes.length > 0) {\r\n            const subIdx = s[0];\r\n            const pos = me.renderingSubMeshes[subIdx].geometricInfo.positions;\r\n            // const pos = me.readAttribute(subIdx, gfx.AttributeName.ATTR_POSITION);\r\n            // if (!pos) { return false; }\r\n\r\n            const pa = new Vec3();\r\n            let posIndex = r[0].vertexIndex0 * 3;\r\n            pa.set(pos[posIndex], pos[posIndex + 1], pos[posIndex + 2]);\r\n\r\n            const pb = new Vec3();\r\n            posIndex = r[0].vertexIndex1 * 3;\r\n            pb.set(pos[posIndex], pos[posIndex + 1], pos[posIndex + 2]);\r\n\r\n            const pc = new Vec3();\r\n            posIndex = r[0].vertexIndex2 * 3;\r\n            pc.set(pos[posIndex], pos[posIndex + 1], pos[posIndex + 2]);\r\n\r\n            position.add(pa);\r\n            position.add(pb);\r\n            position.add(pc);\r\n            position.divide3f(3, 3, 3);\r\n\r\n            const normals = me.readAttribute(subIdx, gfx.AttributeName.ATTR_NORMAL);\r\n            if (normals) {\r\n                let nIdx = r[0].vertexIndex0 * 3;\r\n                pa.set(normals[nIdx], normals[nIdx + 1], normals[nIdx + 2]);\r\n\r\n                nIdx = r[0].vertexIndex1 * 3;\r\n                pb.set(normals[nIdx], normals[nIdx + 1], normals[nIdx + 2]);\r\n\r\n                nIdx = r[0].vertexIndex2 * 3;\r\n                pc.set(normals[nIdx], normals[nIdx + 1], normals[nIdx + 2]);\r\n\r\n                normal.add(pa);\r\n                normal.add(pb);\r\n                normal.add(pc);\r\n                normal.divide3f(3, 3, 3);\r\n            }\r\n        } else {\r\n            this._ray.computeHit(position, r[0].distance);\r\n        }\r\n\r\n        return true;\r\n    }\r\n\r\n    addDecal(position: Vec3, normal: Vec3) {\r\n        position.transformMat4(this.node.worldMatrix);\r\n        const projectorEye = this.mainCamera?.node.worldPosition;\r\n        if (null == projectorEye) {\r\n            return;\r\n        }\r\n        const me = this.meshRenderer?.mesh;\r\n        if (!me) {\r\n            console.log('mesh is null');\r\n            return false;\r\n        }\r\n\r\n        if (this.debugCube) {\r\n            this.debugCube.setWorldPosition(position);\r\n            this.debugCube.removeFromParent();\r\n            this.node.addChild(this.debugCube);\r\n        }\r\n\r\n        const dmr = this.addComponent(DecalMeshRenderer);\r\n        const scale = new Vec3(0.5, 0.5, 4);\r\n        projectorEye.subtract(position).normalize().add(position);\r\n        dmr?.genDecalMesh(this.node, me, projectorEye, position, normal, scale);\r\n        if (dmr && this.decalMaterial) {\r\n            const newMat = new Material();\r\n            newMat.copy(this.decalMaterial);\r\n            newMat.setProperty('albedo', new Vec4(Math.random(), Math.random(), Math.random(), 1));\r\n            dmr.material = newMat;\r\n        }\r\n    }\r\n\r\n    rotateForVectors(a: Vec3, b: Vec3): Mat3 {\r\n        a.normalize();\r\n        b.normalize();\r\n        const v = Vec3.cross(new Vec3(), a, b);\r\n        const c = Vec3.dot(a, b);\r\n        const v1 = v.x;\r\n        const v2 = v.y;\r\n        const v3 = v.z;\r\n        const h = 1 / (1 + c);\r\n\r\n        const vx = new Mat3(\r\n                         0,  -v3,  v2,\r\n                         v3,  0,  -v1,\r\n                        -v2,  v1,  0,\r\n                        )\r\n        const rm = this.matrix3Dot(vx, vx);\r\n        rm.multiplyScalar(h);\r\n        rm.add(vx).add(Mat3.IDENTITY);\r\n\r\n        console.log(a);\r\n        console.log(b);\r\n        console.log(rm);\r\n        return rm;\r\n    }\r\n\r\n    matrix3Dot(ma: Mat3, mb: Mat3): Mat3 {\r\n        const m = new Mat3();\r\n\r\n        m.m00 = ma.m00 * mb.m00 + ma.m01 * mb.m03 + ma.m02 * mb.m06;\r\n        m.m01 = ma.m00 * mb.m01 + ma.m01 * mb.m04 + ma.m02 * mb.m07;\r\n        m.m02 = ma.m00 * mb.m02 + ma.m01 * mb.m05 + ma.m02 * mb.m08;\r\n\r\n        m.m03 = ma.m03 * mb.m00 + ma.m04 * mb.m03 + ma.m05 * mb.m06;\r\n        m.m04 = ma.m03 * mb.m00 + ma.m04 * mb.m04 + ma.m05 * mb.m07;\r\n        m.m05 = ma.m03 * mb.m01 + ma.m04 * mb.m05 + ma.m05 * mb.m08;\r\n\r\n        m.m06 = ma.m06 * mb.m00 + ma.m07 * mb.m03 + ma.m08 * mb.m06;\r\n        m.m07 = ma.m06 * mb.m03 + ma.m07 * mb.m04 + ma.m08 * mb.m07;\r\n        m.m08 = ma.m06 * mb.m00 + ma.m07 * mb.m05 + ma.m08 * mb.m08;\r\n\r\n        return m;\r\n    }\r\n\r\n    matrix4Dot(ma: Mat4, mb: Mat4): Mat4 {\r\n        const m = new Mat4();\r\n\r\n        m.m00 = ma.m00 * mb.m00 + ma.m01 * mb.m04 + ma.m02 * mb.m08 + ma.m03 * mb.m12;\r\n        m.m01 = ma.m00 * mb.m01 + ma.m01 * mb.m05 + ma.m02 * mb.m09 + ma.m03 * mb.m13;\r\n        m.m02 = ma.m00 * mb.m02 + ma.m01 * mb.m06 + ma.m02 * mb.m10 + ma.m03 * mb.m14;\r\n        m.m03 = ma.m00 * mb.m03 + ma.m01 * mb.m07 + ma.m02 * mb.m11 + ma.m03 * mb.m15;\r\n\r\n        m.m04 = ma.m04 * mb.m00 + ma.m05 * mb.m04 + ma.m06 * mb.m08 + ma.m07 * mb.m12;\r\n        m.m05 = ma.m04 * mb.m01 + ma.m05 * mb.m05 + ma.m06 * mb.m09 + ma.m07 * mb.m13;\r\n        m.m06 = ma.m04 * mb.m02 + ma.m05 * mb.m06 + ma.m06 * mb.m10 + ma.m07 * mb.m14;\r\n        m.m07 = ma.m04 * mb.m03 + ma.m05 * mb.m07 + ma.m06 * mb.m11 + ma.m07 * mb.m15;\r\n\r\n        m.m08 = ma.m08 * mb.m00 + ma.m09 * mb.m04 + ma.m10 * mb.m08 + ma.m11 * mb.m12;\r\n        m.m09 = ma.m08 * mb.m01 + ma.m09 * mb.m05 + ma.m10 * mb.m09 + ma.m11 * mb.m13;\r\n        m.m10 = ma.m08 * mb.m02 + ma.m09 * mb.m06 + ma.m10 * mb.m10 + ma.m11 * mb.m14;\r\n        m.m11 = ma.m08 * mb.m03 + ma.m09 * mb.m07 + ma.m10 * mb.m11 + ma.m11 * mb.m15;\r\n\r\n        m.m12 = ma.m12 * mb.m00 + ma.m13 * mb.m04 + ma.m14 * mb.m08 + ma.m15 * mb.m12;\r\n        m.m13 = ma.m12 * mb.m01 + ma.m13 * mb.m05 + ma.m14 * mb.m09 + ma.m15 * mb.m13;\r\n        m.m14 = ma.m12 * mb.m02 + ma.m13 * mb.m06 + ma.m14 * mb.m10 + ma.m15 * mb.m14;\r\n        m.m15 = ma.m12 * mb.m03 + ma.m13 * mb.m07 + ma.m14 * mb.m11 + ma.m15 * mb.m15;\r\n\r\n        return m;\r\n    }\r\n\r\n}\r\n\r\n"]}