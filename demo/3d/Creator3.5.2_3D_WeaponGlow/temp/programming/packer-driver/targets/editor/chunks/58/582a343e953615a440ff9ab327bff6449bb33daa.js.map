{"version":3,"sources":["file:///Users/mu/work/gitee/CocosCreatorDemos/demo/3d/Creator3.5.2_3D_WeaponGlow/assets/src/FollowCamera.ts"],"names":["_decorator","Component","Node","systemEvent","SystemEvent","EventMouse","Vec3","Quat","quat","Camera","ccclass","property","FollowCamera","type","_isMouseDown","_targetPos","_cameraPos","_lookDir","_lookRight","_lookUp","_rotate","_zoom","_minZoom","_maxZoom","_zoomSensitivty","inst","_inst","setFollowTarget","target","start","on","EventType","MOUSE_DOWN","onMouseDown","MOUSE_UP","onMouseUp","MOUSE_MOVE","onMouseMove","MOUSE_WHEEL","onMouseWheel","adjustCamera","lookDir","rotationEulers","euler","node","eulerAngles","clone","x","y","z","normalize","set","cross","fromAxes","setRotation","multiplyScalar","subtract","camera","setPosition","event","getButton","BUTTON_RIGHT","deltaX","getUIDeltaX","deltaY","getUIDeltaY","rotate","rx","ry","angles","setRotationFromEuler","zoom","delta","getScrollY","update","deltaTime","getPosition","add","lookAtOffset"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, systemEvent, SystemEvent, EventMouse, Vec3, Quat, quat, Camera } from 'cc';\nconst { ccclass, property } = _decorator;\n\n@ccclass('FollowCamera')\nexport class FollowCamera extends Component {\n    private static _inst: FollowCamera = null;\n    public static get inst(): FollowCamera {\n        return this._inst;\n    }\n\n    @property({ type: Node })\n    target: Node = null;\n\n    @property({ type: Camera })\n    camera:Camera = null;\n\n    @property({ type: Vec3 })\n    lookAtOffset: Vec3 = new Vec3(0, 10, 0);\n\n    private _isMouseDown = false;\n    private _targetPos = new Vec3(0, 0, 0);\n    private _cameraPos = new Vec3(0, 0, 0);\n    private _lookDir = new Vec3(0, 0, -1);\n    private _lookRight = new Vec3(1, 0, 0);\n    private _lookUp = new Vec3(0, 1, 0);\n    private _rotate = quat();\n    private _zoom = 4;\n    private _minZoom = 2;\n    private _maxZoom = 6;\n    private _zoomSensitivty = 0.02;\n\n    setFollowTarget(target: Node) {\n        this.target = target;\n    }\n\n    start() {\n        FollowCamera._inst = this;\n        // Your initialization goes here.\n        systemEvent.on(SystemEvent.EventType.MOUSE_DOWN, this.onMouseDown, this);\n        systemEvent.on(SystemEvent.EventType.MOUSE_UP, this.onMouseUp, this);\n        systemEvent.on(SystemEvent.EventType.MOUSE_MOVE, this.onMouseMove, this);\n        systemEvent.on(SystemEvent.EventType.MOUSE_WHEEL, this.onMouseWheel, this);\n\n        this.adjustCamera();\n    }\n\n    public get lookDir(): Vec3 {\n        return this.lookDir;\n    }\n\n    public get rotationEulers(): Vec3 {\n        let euler = this.node.eulerAngles.clone();\n        euler.x *= -1;\n        euler.y *= -1;\n        euler.z *= -1;\n        return euler;\n    }\n\n    adjustCamera() {\n        if (!this.target) {\n            return;\n        }\n\n        Vec3.normalize(this._lookDir, this._lookDir);\n\n        this._lookUp.set(0, 1, 0);\n\n        //取右向量\n        Vec3.cross(this._lookRight, this._lookDir, this._lookUp);\n        Vec3.normalize(this._lookRight, this._lookRight);\n\n        //取得真实的UP向量\n        Vec3.cross(this._lookUp, this._lookRight, this._lookDir);\n        Vec3.normalize(this._lookUp, this._lookUp);\n\n        Quat.fromAxes(this._rotate, this._lookRight, this._lookUp, this._lookDir);\n        this.node.setRotation(this._rotate);\n\n\n        //从观察点开始，把摄相机往后推zoom距离\n        Vec3.multiplyScalar(this._lookDir, this._lookDir, this._zoom);\n        Vec3.subtract(this._cameraPos, new Vec3(0, 0, 0), this._lookDir);\n        this.camera.node.setPosition(this._cameraPos);\n    }\n\n    onMouseDown(event: EventMouse) {\n        if(event.getButton() == EventMouse.BUTTON_RIGHT){\n            this._isMouseDown = true;\n        }\n    }\n\n    onMouseUp() {\n        this._isMouseDown = false;\n    }\n\n    onMouseMove(event: EventMouse) {\n        if (!this._isMouseDown) {\n            return;\n        }\n        let deltaX = event.getUIDeltaX() * 0.1;\n        let deltaY = event.getUIDeltaY() * 0.1;\n        this.rotate(deltaY,-deltaX);\n    }\n\n    rotate(rx:number,ry:number){\n        let angles = this.node.eulerAngles;\n        this.node.setRotationFromEuler(angles.x + rx, angles.y + ry, angles.z);\n    }\n\n    zoom(delta:number){\n        this._zoom += delta * this._zoomSensitivty;\n        if (this._zoom < this._minZoom) {\n            this._zoom = this._minZoom;\n        }\n        if (this._zoom > this._maxZoom) {\n            this._zoom = this._maxZoom;\n        }\n\n        //从观察点开始，把摄相机往后推zoom距离\n        Vec3.normalize(this._lookDir, this._lookDir);\n        Vec3.multiplyScalar(this._lookDir, this._lookDir, this._zoom);\n        Vec3.subtract(this._cameraPos, new Vec3(0, 0, 0), this._lookDir);\n        this.camera.node.setPosition(this._cameraPos);\n    }\n\n\n    onMouseWheel(event: EventMouse) {\n        let delta = event.getScrollY() * this._zoomSensitivty;\n        this.zoom(delta);\n    }\n\n    update(deltaTime: number) {\n        // Your update function goes here.\n        if (this.target) {\n            this.target.getPosition(this._targetPos);\n            Vec3.add(this._targetPos, this._targetPos, this.lookAtOffset);\n            this.node.setPosition(this._targetPos);\n        }\n    }\n}\n"]}